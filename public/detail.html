<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anzeige Details - RechtUndOrdnung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a href="/dashboard.html" class="navbar-brand">‚Üê Zur√ºck</a>
            <div>
                <a href="/public.html" class="btn btn-outline-light btn-sm me-2">√ñffentliche Anzeigen</a>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="reportDetail"></div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        const token = localStorage.getItem('token');
        const params = new URLSearchParams(window.location.search);
        const reportId = params.get('id');

        if (!token) window.location.href = '/';
        if (!reportId) window.location.href = '/dashboard.html';

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        async function loadReport() {
            try {
                const res = await fetch(`${API}/reports/${reportId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    if (res.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error('Report nicht gefunden');
                }

                const data = await res.json();
                const { report, photos, documents, history } = data;

                // Generate email preview
                const caseEmail = report.case_number.toLowerCase().replace(/\//g, '-') + '@rechtundordnung.treudler.net';
                const emailBody = `Sehr geehrte Damen und Herren,

hiermit melde ich einen DSGVO-Versto√ü im Bereich Video√ºberwachung.

Aktenzeichen: ${report.case_number}
Standort: ${report.location_address || 'Keine Adresse verf√ºgbar'}
Versto√ü: ${report.violation_type || 'Nicht angegeben'}

${report.notes || ''}

Fotos im Anhang.

Mit freundlichen Gr√º√üen
Diese E-Mail wurde automatisch generiert von rechtundordnung.de`;

                document.getElementById('reportDetail').innerHTML = `
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h3>${report.case_number}</h3>
                            <span class="badge bg-light text-dark">${getStatusText(report.status)}</span>
                        </div>
                        <div class="card-body">
                            <h5>Details</h5>
                            <p><strong>Versto√ü:</strong> ${report.violation_type || 'Nicht angegeben'}</p>
                            <p><strong>Standort:</strong> ${report.location_address || 'Nicht verf√ºgbar'}</p>
                            ${report.notes ? `<p><strong>Hinweise:</strong> ${report.notes}</p>` : ''}
                            <p><strong>√ñffentlich:</strong> ${report.is_public ? 'Ja' : 'Nein'}</p>
                            ${report.is_public ? `<p><strong>Anonym:</strong> ${report.hide_username ? 'Ja (Name versteckt)' : 'Nein (Name sichtbar)'}</p>` : ''}
                            <p><strong>Erstellt:</strong> ${new Date(report.created_at).toLocaleString('de-DE')}</p>
                            ${report.submitted_at ? `<p><strong>Versendet:</strong> ${new Date(report.submitted_at).toLocaleString('de-DE')}</p>` : ''}

                            <hr>

                            <h5>üìß Zust√§ndiges Ordnungsamt</h5>
                            ${report.district_email ? `
                                <div class="alert alert-success">
                                    <p class="mb-1"><strong>Name:</strong> ${report.district_name || 'Unbekannt'}</p>
                                    <p class="mb-1"><strong>E-Mail:</strong> ${report.district_email}</p>
                                    ${report.district_zip ? `<p class="mb-0"><strong>PLZ:</strong> ${report.district_zip}</p>` : ''}
                                </div>
                            ` : `
                                <div class="alert alert-danger">
                                    <strong>‚ö†Ô∏è Kein Ordnungsamt verf√ºgbar!</strong><br>
                                    F√ºr diesen Standort konnte kein zust√§ndiges Ordnungsamt gefunden werden.
                                    ${report.status === 'draft' ? '<br>Die Anzeige kann nicht versendet werden.' : ''}
                                </div>
                            `}

                            ${report.status === 'draft' && report.district_email ? `
                                <hr>
                                <h5>üìß E-Mail Vorschau</h5>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <p class="mb-1"><strong>Von:</strong> RechtUndOrdnung &lt;${caseEmail}&gt;</p>
                                        <p class="mb-1"><strong>An:</strong> ${report.district_email}</p>
                                        <p class="mb-1"><strong>Antwort an:</strong> ${caseEmail}</p>
                                        <p class="mb-3"><strong>Betreff:</strong> DSGVO-Versto√ü - Aktenzeichen ${report.case_number}</p>
                                        <p class="mb-1"><strong>Anh√§nge:</strong> ${photos.length} Datei(en)</p>
                                        <hr>
                                        <pre style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem;">${emailBody}</pre>
                                    </div>
                                </div>
                            ` : ''}

                            <hr>

                            <h5>Medien (${photos.length})</h5>
                            <div class="row">
                                ${photos.map(photo => `
                                    <div class="col-md-3 mb-3">
                                        ${photo.media_type === 'video' ?
                                            `<video src="/${photo.filepath}" class="img-fluid img-thumbnail" controls style="max-height:200px;width:100%;object-fit:cover;"></video>` :
                                            `<img src="/${photo.filepath}" class="img-fluid img-thumbnail" alt="${photo.filename}">`
                                        }
                                        <small class="text-muted d-block">${photo.filename}</small>
                                        ${photo.lat && photo.lng ? `<small>üìç ${parseFloat(photo.lat).toFixed(6)}, ${parseFloat(photo.lng).toFixed(6)}</small>` : ''}
                                    </div>
                                `).join('')}
                            </div>

                            ${documents.length > 0 ? `
                                <hr>
                                <h5>Dokumente (${documents.length})</h5>
                                <ul class="list-group">
                                    ${documents.map(doc => `
                                        <li class="list-group-item">
                                            ${doc.filename}
                                            <span class="badge bg-secondary">${doc.file_type}</span>
                                            <small class="text-muted">${doc.uploaded_by_user ? 'Von Ihnen' : 'Von Beh√∂rde'}</small>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : ''}

                            ${history.length > 0 ? `
                                <hr>
                                <h5>Status-Verlauf</h5>
                                <ul class="list-group">
                                    ${history.map(h => `
                                        <li class="list-group-item">
                                            <strong>${getStatusText(h.new_status)}</strong>
                                            ${h.old_status ? ` (von ${getStatusText(h.old_status)})` : ''}
                                            <br>
                                            <small class="text-muted">${new Date(h.created_at).toLocaleString('de-DE')}</small>
                                            ${h.notes ? `<br><small>${h.notes}</small>` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    </div>
                `;
            } catch (error) {
                alert('Fehler beim Laden: ' + error.message);
                window.location.href = '/dashboard.html';
            }
        }

        function getStatusText(status) {
            const texts = {
                'draft': 'Entwurf',
                'submitted': 'Versendet',
                'in_progress': 'In Bearbeitung',
                'completed': 'Abgeschlossen',
                'rejected': 'Abgelehnt'
            };
            return texts[status] || status;
        }

        loadReport();
    </script>
</body>
</html>
